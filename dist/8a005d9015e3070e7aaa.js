function sendDataToServer(){showStatus("Lese Daten aus Excel...","normal"),Excel.run((function(e){var t=e.workbook.worksheets.getActiveWorksheet();return t.load("name"),e.sync().then((function(){var n=t.name;console.log("Aktives Arbeitsblatt:",n);var o=n.toLowerCase(),a=["pax","time","mainroom","sideroom1","sideroom2","sideroom3","sideroom4","sideroom5","sideroom6","sideroom7","sideroom8","chairs","setup","setdown","manager","pa","extra1","extra2","extra3","extra4","extra5","extraclick1","extraclick2","extraclick3","extraclick4","extraclick5"],r=["pa","extraclick1","extraclick2","extraclick3","extraclick4","extraclick5"],s=e.workbook.names;s.load("items/name, items/type");var i={ws_format:o,format:"both"};return a.forEach((function(e){i[e]=null})),e.sync().then((function(){console.log("Gefundene benannte Bereiche:",s.items.map((function(e){return{name:e.name,type:e.type}})));for(var t=[],n=0;n<a.length;n++)for(var c=a[n],l=o+"_"+c,d=0;d<s.items.length;d++)if(s.items[d].name.toLowerCase()===l){t.push({name:s.items[d].name,functionName:c,isCheckbox:r.includes(c)});break}return console.log("Zu verarbeitende benannte Bereiche:",t),processNamedItems(e,t,i,0)}))})).then((function(e){console.log("Gesammelte Daten:",e),showStatus("Daten erfolgreich ausgelesen. Bereite Präsentation vor...","normal");var t="https://musicworksnas.synology.me:5049/api/concept",n={ws_format:e.ws_format,format:e.format},o=["pa","extraclick1","extraclick2","extraclick3","extraclick4","extraclick5"];return Object.keys(e).forEach((function(t){"format"!==t&&"ws_format"!==t&&(null!==e[t]&&void 0!==e[t]?o.includes(t)?n[t]=e[t]:n[t]=String(e[t]):n[t]=null)})),console.log("Daten, die an die API gesendet werden:",n),fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then((function(e){if(!e.ok)throw new Error("Netzwerkfehler: "+e.status);var t=e.headers.get("content-type");return t&&t.includes("application/json")?e.json().then((function(e){return{type:"json",data:e}})):e.blob().then((function(e){return{type:"blob",data:e}}))})).then((function(e){if("json"===e.type){var n=e.data,o=new URL(t).origin,a=o+n.pptx_url,r=o+n.pdf_url;console.log("Download-URLs:",{pptx:a,pdf:r}),createDownloadLinks(a,r),showStatus("Dateien bereit zum Download.","success")}else{var s=e.data,i=getFilenameFromContentType(s.type,response.headers.get("content-disposition"));createSingleDownloadLink(URL.createObjectURL(s),i),showStatus("Datei bereit zum Download.","success")}}))})).catch((function(e){showStatus("Fehler bei der Verarbeitung: "+e.message,"error"),console.error("Fehler:",e)}))}))}function processNamedItems(e,t,n,o){if(o>=t.length)return n;var a=t[o];try{var r=e.workbook.names.getItem(a.name).getRange();return r.load("values"),e.sync().then((function(){try{var s=r.values[0][0];null!=s&&(a.isCheckbox&&(s=!0===s||"ja"===s||"yes"===s||1===s),n[a.functionName]=s,console.log("Wert für ".concat(a.functionName," gefunden:"),s))}catch(e){console.error("Fehler beim Lesen des Werts für ".concat(a.name,":"),e)}return processNamedItems(e,t,n,o+1)}))}catch(r){return console.error("Fehler beim Laden des Bereichs für ".concat(a.name,":"),r),processNamedItems(e,t,n,o+1)}}function getTestData(){return{ws_format:"dgbdw",pax:"80",time:"4 Stunden",mainroom:"150",sideroom1:"45",sideroom2:"45",sideroom3:"20",chairs:"90",setup:"90",setdown:"30",manager:"JR",pa:!0,extra1:"Testdaten",extra2:"Beispiel",extraclick1:!0,format:"both"}}function createDownloadLinks(e,t){var n=document.getElementById("downloadContainer");n.innerHTML="";var o=document.createElement("a");o.href=e,o.className="download-button pptx-button",o.textContent="PowerPoint Download",o.download="praesentation.pptx";var a=document.createElement("a");a.href=t,a.className="download-button pdf-button",a.textContent="PDF Download",a.download="praesentation.pdf";var r=document.createElement("p");r.className="download-info",r.textContent='Klicke mit Rechtsklick auf die Buttons und wähle "Link speichern unter" um die Dateien herunterzuladen.',n.appendChild(o),n.appendChild(a),n.appendChild(r),n.style.display="block"}function createSingleDownloadLink(e,t){var n=document.getElementById("downloadContainer");n.innerHTML="";var o=document.createElement("a");o.href=e,o.className="download-button",t.endsWith(".pptx")?(o.className+=" pptx-button",o.textContent="PowerPoint-Präsentation herunterladen"):t.endsWith(".pdf")?(o.className+=" pdf-button",o.textContent="PDF-Version herunterladen"):o.textContent="Datei herunterladen",o.download=t;var a=document.createElement("p");a.className="download-info",a.textContent="Klicken Sie auf den Button, um die Datei herunterzuladen.",n.appendChild(o),n.appendChild(a),n.style.display="block"}function getFilenameFromContentType(e,t){var n="praesentation";if(t){var o=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(t);o&&o[1]&&(n=o[1].replace(/['"]/g,""))}return n.includes(".")||(e.includes("application/vnd.openxmlformats-officedocument.presentationml.presentation")?n+=".pptx":e.includes("application/pdf")&&(n+=".pdf")),n}function showStatus(e,t){var n=$("#statusMessage");n.removeClass("success error"),n.text(e),"success"===t?n.addClass("success"):"error"===t&&n.addClass("error")}Office.initialize=function(e){$(document).ready((function(){$("#serverButton").click(sendDataToServer),showStatus("Add-In geladen und bereit.")}))};